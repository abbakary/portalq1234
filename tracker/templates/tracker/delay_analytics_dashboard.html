{% extends 'tracker/base.html' %}
{% load static %}

{% block title %}Delay Analytics Dashboard{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-color: #4f46e5;
    --secondary-color: #10b981;
    --accent-color: #f59e0b;
    --danger-color: #ef4444;
    --warning-color: #f59e0b;
    --info-color: #0ea5e9;
    --dark-color: #1f2937;
    --light-bg: #f9fafb;
    --border-color: #e5e7eb;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
}

.dashboard-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #7c3aed 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-lg);
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.kpi-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-color);
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
    overflow: hidden;
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-color);
}

.kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.kpi-card.primary::before { background: var(--primary-color); }
.kpi-card.success::before { background: var(--secondary-color); }
.kpi-card.warning::before { background: var(--warning-color); }
.kpi-card.danger::before { background: var(--danger-color); }
.kpi-card.info::before { background: var(--info-color); }

.kpi-card.primary { border-left-color: var(--primary-color); }
.kpi-card.success { border-left-color: var(--secondary-color); }
.kpi-card.warning { border-left-color: var(--warning-color); }
.kpi-card.danger { border-left-color: var(--danger-color); }
.kpi-card.info { border-left-color: var(--info-color); }

.kpi-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 1rem;
    background: rgba(79, 70, 229, 0.1);
    color: var(--primary-color);
}

.kpi-card.success .kpi-icon {
    background: rgba(16, 185, 129, 0.1);
    color: var(--secondary-color);
}

.kpi-card.warning .kpi-icon {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
}

.kpi-card.danger .kpi-icon {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger-color);
}

.kpi-card.info .kpi-icon {
    background: rgba(14, 165, 233, 0.1);
    color: var(--info-color);
}

.kpi-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--dark-color);
    line-height: 1;
}

.kpi-label {
    font-size: 0.9rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.kpi-trend {
    font-size: 0.85rem;
    color: #9ca3af;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    margin-top: 0.5rem;
}

.filter-section {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
}

.filter-section .row {
    margin-bottom: 1rem;
}

.chart-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
    min-height: 400px;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--light-bg);
}

.chart-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--dark-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.chart-container {
    position: relative;
    height: 350px;
    margin-top: 1rem;
}

.reason-list {
    max-height: 500px;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.reason-list::-webkit-scrollbar {
    width: 6px;
}

.reason-list::-webkit-scrollbar-track {
    background: var(--light-bg);
    border-radius: 3px;
}

.reason-list::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 3px;
}

.reason-list::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
}

.reason-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    margin-bottom: 0.75rem;
    background: var(--light-bg);
    border-radius: 8px;
    border-left: 3px solid var(--primary-color);
    transition: all 0.2s;
}

.reason-item:hover {
    background: #f3f4f6;
    transform: translateX(4px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.reason-text {
    flex: 1;
    font-weight: 600;
    color: var(--dark-color);
    font-size: 0.95rem;
}

.reason-category {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 0.25rem;
    font-style: italic;
}

.reason-stats {
    text-align: right;
    margin-left: 1rem;
    min-width: 80px;
}

.reason-count {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
    line-height: 1;
}

.reason-percentage {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.recommendation-card {
    background: white;
    padding: 1.25rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 1rem;
    border-left: 4px solid var(--primary-color);
    transition: all 0.2s;
}

.recommendation-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.recommendation-card.high {
    border-left-color: var(--danger-color);
}

.recommendation-card.medium {
    border-left-color: var(--warning-color);
}

.recommendation-card.low {
    border-left-color: var(--info-color);
}

.recommendation-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.recommendation-title {
    font-weight: 700;
    color: var(--dark-color);
    font-size: 1.1rem;
}

.recommendation-priority {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.recommendation-priority.high {
    background: rgba(239, 68, 68, 0.1);
    color: #991b1b;
}

.recommendation-priority.medium {
    background: rgba(245, 158, 11, 0.1);
    color: #78350f;
}

.recommendation-priority.low {
    background: rgba(14, 165, 233, 0.1);
    color: #0c4a6e;
}

.recommendation-category {
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.recommendation-description {
    color: #4b5563;
    line-height: 1.6;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 3rem;
    color: var(--primary-color);
}

.loading-spinner.active {
    display: block;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #9ca3af;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.impact-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.impact-metric {
    text-align: center;
    padding: 1.5rem;
    background: var(--light-bg);
    border-radius: 8px;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.impact-metric:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.impact-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
    line-height: 1;
}

.impact-label {
    font-size: 0.85rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.filter-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--light-bg);
    border-radius: 20px;
    font-size: 0.85rem;
    margin: 0.25rem;
}

.filter-badge .badge-text {
    font-weight: 600;
    color: var(--dark-color);
}

.filter-badge .badge-close {
    cursor: pointer;
    color: #6b7280;
    font-weight: bold;
    padding: 0 0.25rem;
}

.filter-badge .badge-close:hover {
    color: var(--danger-color);
}

.active-filters {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

@media (max-width: 768px) {
    .kpi-grid {
        grid-template-columns: 1fr;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .impact-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                <h2 class="mb-2"><i class="fa fa-chart-line me-2"></i>Delay Analytics Dashboard</h2>
                <p class="mb-0 opacity-90">Comprehensive analysis of order delays and improvement insights</p>
                </div>
        </div>
            </div>

    <!-- Filters -->
    <div class="filter-section">
        <form method="get" id="filterForm" class="row g-3">
                        <div class="col-md-3">
                <label class="form-label fw-semibold">Time Period</label>
                <select name="period" class="form-select" id="periodSelect">
                                <option value="7days" {% if time_period == '7days' %}selected{% endif %}>Last 7 Days</option>
                                <option value="30days" {% if time_period == '30days' %}selected{% endif %}>Last 30 Days</option>
                                <option value="90days" {% if time_period == '90days' %}selected{% endif %}>Last 90 Days</option>
                                <option value="6months" {% if time_period == '6months' %}selected{% endif %}>Last 6 Months</option>
                                <option value="1year" {% if time_period == '1year' %}selected{% endif %}>Last Year</option>
                                <option value="all" {% if time_period == 'all' %}selected{% endif %}>All Time</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                <label class="form-label fw-semibold">Category</label>
                <select name="category" class="form-select" id="categorySelect">
                                <option value="">All Categories</option>
                    {% for cat_code, cat_name in categories %}
                    <option value="{{ cat_code }}" {% if selected_category == cat_code %}selected{% endif %}>{{ cat_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                <label class="form-label fw-semibold">Order Type</label>
                <select name="order_type" class="form-select" id="orderTypeSelect">
                                <option value="">All Types</option>
                    {% for type_code, type_name in order_types %}
                    <option value="{{ type_code }}" {% if selected_order_type == type_code %}selected{% endif %}>{{ type_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                <label class="form-label fw-semibold">User</label>
                <select name="user" class="form-select" id="userSelect">
                    <option value="">All Users</option>
                                {% for user in users %}
                    <option value="{{ user.id }}" {% if selected_user == user.id|stringformat:"s" %}selected{% endif %}>
                        {% if user.first_name or user.last_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.username }}{% endif %}
                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-filter me-2"></i>Apply Filters
                            </button>
                <a href="{% url 'tracker:delay_analytics_dashboard' %}" class="btn btn-outline-secondary ms-2">
                    <i class="fa fa-rotate-left me-2"></i>Reset Filters
                </a>
                        </div>
            <!-- Active Filters Display -->
            {% if selected_category or selected_order_type or selected_user %}
            <div class="col-12 active-filters">
                <small class="text-muted d-block mb-2"><strong>Active Filters:</strong></small>
                <div class="d-flex flex-wrap gap-2">
                    {% if selected_category %}
                    <span class="filter-badge">
                        <span class="badge-text">Category: {{ selected_category|title }}</span>
                        <a href="?{% if time_period %}period={{ time_period }}&{% endif %}{% if selected_order_type %}order_type={{ selected_order_type }}&{% endif %}{% if selected_user %}user={{ selected_user }}{% endif %}" class="badge-close">×</a>
                    </span>
                    {% endif %}
                    {% if selected_order_type %}
                    <span class="filter-badge">
                        <span class="badge-text">Type: {{ selected_order_type|title }}</span>
                        <a href="?{% if time_period %}period={{ time_period }}&{% endif %}{% if selected_category %}category={{ selected_category }}&{% endif %}{% if selected_user %}user={{ selected_user }}{% endif %}" class="badge-close">×</a>
                    </span>
                    {% endif %}
                    {% if selected_user %}
                    <span class="filter-badge">
                        <span class="badge-text">User: {% for u in users %}{% if u.id|stringformat:"s" == selected_user %}{% if u.first_name or u.last_name %}{{ u.first_name }} {{ u.last_name }}{% else %}{{ u.username }}{% endif %}{% endif %}{% endfor %}</span>
                        <a href="?{% if time_period %}period={{ time_period }}&{% endif %}{% if selected_category %}category={{ selected_category }}&{% endif %}{% if selected_order_type %}order_type={{ selected_order_type }}{% endif %}" class="badge-close">×</a>
                    </span>
                    {% endif %}
                    </div>
                </div>
            {% endif %}
        </form>
            </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <i class="fa fa-spinner fa-spin fa-3x"></i>
        <p class="mt-3">Loading analytics...</p>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid" id="kpiCards">
        <div class="kpi-card primary">
            <div class="kpi-icon"><i class="fa fa-clock"></i></div>
            <div class="kpi-value" id="totalDelayed">0</div>
            <div class="kpi-label">Total Delayed Orders</div>
            <div class="kpi-trend"><i class="fa fa-info-circle"></i> Orders with delay reasons</div>
                        </div>
        <div class="kpi-card info">
            <div class="kpi-icon"><i class="fa fa-percentage"></i></div>
            <div class="kpi-value" id="delayRate">0%</div>
            <div class="kpi-label">Delay Rate</div>
            <div class="kpi-trend"><i class="fa fa-chart-line"></i> Percentage of all orders</div>
                        </div>
        <div class="kpi-card danger">
            <div class="kpi-icon"><i class="fa fa-exclamation-triangle"></i></div>
            <div class="kpi-value" id="exceeded2Hours">0</div>
            <div class="kpi-label">Exceeded 2 Hours</div>
            <div class="kpi-trend"><i class="fa fa-warning"></i> Critical delays</div>
                    </div>
        <div class="kpi-card warning">
            <div class="kpi-icon"><i class="fa fa-hourglass-half"></i></div>
            <div class="kpi-value" id="avgHours">0.0</div>
            <div class="kpi-label">Avg. Duration</div>
            <div class="kpi-trend"><i class="fa fa-clock"></i> Hours per delayed order</div>
                </div>
            </div>

    <!-- Charts Row 1 -->
    <div class="row">
        <!-- Delay Reasons Breakdown -->
        <div class="col-lg-6">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fa fa-pie-chart"></i>Delay Reasons by Category
        </div>
                        </div>
                <div class="chart-container">
                    <canvas id="categoryBreakdownChart"></canvas>
                        </div>
                <div id="categoryEmptyState" class="empty-state" style="display:none;">
                    <div class="empty-state-icon"><i class="fa fa-pie-chart"></i></div>
                    <p>No category data available</p>
                    </div>
                </div>
            </div>

        <!-- Delay Trends -->
        <div class="col-lg-6">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fa fa-line-chart"></i>Delay Trends Over Time
        </div>
                        </div>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                        </div>
                <div id="trendsEmptyState" class="empty-state" style="display:none;">
                    <div class="empty-state-icon"><i class="fa fa-line-chart"></i></div>
                    <p>No trend data available</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fa fa-tags"></i>Delays by Order Type
                </div>
                </div>
                <div class="chart-container">
                    <canvas id="orderTypeChart"></canvas>
            </div>
                <div id="orderTypeEmptyState" class="empty-state" style="display:none;">
                    <div class="empty-state-icon"><i class="fa fa-tags"></i></div>
                    <p>No order type data available</p>
        </div>
        </div>
    </div>

        <div class="col-lg-6">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fa fa-users"></i>Delays by User
                </div>
                </div>
                <div class="chart-container">
                    <canvas id="userChart"></canvas>
            </div>
                <div id="userEmptyState" class="empty-state" style="display:none;">
                    <div class="empty-state-icon"><i class="fa fa-users"></i></div>
                    <p>No user data available</p>
        </div>
            </div>
        </div>
    </div>

    <!-- Top Delay Reasons List -->
    <div class="chart-card">
        <div class="chart-header">
            <div class="chart-title">
                <i class="fa fa-list"></i>Top Delay Reasons
                </div>
                </div>
        <div class="reason-list" id="topReasonsList">
            <div class="empty-state">
                <div class="empty-state-icon"><i class="fa fa-spinner fa-spin"></i></div>
                <p>Loading delay reasons...</p>
            </div>
        </div>
    </div>

    <!-- Impact Analysis -->
    <div class="chart-card">
        <div class="chart-header">
            <div class="chart-title">
                <i class="fa fa-exclamation-circle"></i>Impact Analysis
                </div>
                            </div>
        <div class="impact-grid" id="impactMetrics">
            <div class="empty-state">
                <div class="empty-state-icon"><i class="fa fa-spinner fa-spin"></i></div>
                <p>Loading impact metrics...</p>
            </div>
        </div>
    </div>

    <!-- Recommendations -->
    <div class="chart-card">
        <div class="chart-header">
            <div class="chart-title">
                <i class="fa fa-lightbulb"></i>Improvement Recommendations
                </div>
                    </div>
        <div id="recommendationsList">
            <div class="empty-state">
                <div class="empty-state-icon"><i class="fa fa-spinner fa-spin"></i></div>
                <p>Loading recommendations...</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let charts = {};
    const filters = {
        period: '{{ time_period }}',
        category: '{{ selected_category }}',
        order_type: '{{ selected_order_type }}',
        user: '{{ selected_user }}'
    };

    // Update filters from form
    function updateFilters() {
        filters.period = document.getElementById('periodSelect').value;
        filters.category = document.getElementById('categorySelect').value;
        filters.order_type = document.getElementById('orderTypeSelect').value;
        filters.user = document.getElementById('userSelect').value;
    }

    // Build API URL with filters
    function buildApiUrl(endpoint) {
        const url = new URL(endpoint, window.location.origin);
        Object.keys(filters).forEach(key => {
            if (filters[key]) {
                url.searchParams.append(key, filters[key]);
            }
        });
        return url.toString();
    }

    // Show/hide loading
    function showLoading(show) {
        document.getElementById('loadingSpinner').classList.toggle('active', show);
    }

    // Load all analytics data
    function loadAnalytics() {
        showLoading(true);
        updateFilters();

        // Load summary
        fetch(buildApiUrl('/tracker/api/analytics/delays/summary/'))
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    updateKPIs(data.summary, data.top_reasons);
                }
            })
            .catch(e => {
                console.error('Error loading summary:', e);
                showLoading(false);
            });

        // Load category breakdown
        fetch(buildApiUrl('/tracker/api/analytics/delays/breakdown/'))
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    renderCategoryChart(data.data);
                    document.getElementById('categoryEmptyState').style.display = 'none';
                } else {
                    if (charts.categoryBreakdown) charts.categoryBreakdown.destroy();
                    document.getElementById('categoryEmptyState').style.display = 'block';
                }
            })
            .catch(e => {
                console.error('Error loading breakdown:', e);
                document.getElementById('categoryEmptyState').style.display = 'block';
            });

        // Load trends
        fetch(buildApiUrl('/tracker/api/analytics/delays/trends/'))
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    renderTrendsChart(data.data);
                    document.getElementById('trendsEmptyState').style.display = 'none';
                } else {
                    if (charts.trends) charts.trends.destroy();
                    document.getElementById('trendsEmptyState').style.display = 'block';
                }
            })
            .catch(e => {
                console.error('Error loading trends:', e);
                document.getElementById('trendsEmptyState').style.display = 'block';
            });

        // Load by order type
        fetch(buildApiUrl('/tracker/api/analytics/delays/by-type/'))
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    renderOrderTypeChart(data.data);
                    document.getElementById('orderTypeEmptyState').style.display = 'none';
                } else {
                    if (charts.orderType) charts.orderType.destroy();
                    document.getElementById('orderTypeEmptyState').style.display = 'block';
                }
            })
            .catch(e => {
                console.error('Error loading order type:', e);
                document.getElementById('orderTypeEmptyState').style.display = 'block';
            });

        // Load by user
        fetch(buildApiUrl('/tracker/api/analytics/delays/by-user/'))
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    renderUserChart(data.data);
                    document.getElementById('userEmptyState').style.display = 'none';
                } else {
                    if (charts.user) charts.user.destroy();
                    document.getElementById('userEmptyState').style.display = 'block';
                }
            })
            .catch(e => {
                console.error('Error loading user data:', e);
                document.getElementById('userEmptyState').style.display = 'block';
            });

        // Load all delay reasons
        fetch(buildApiUrl('/tracker/api/analytics/delays/all-reasons/'))
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    renderTopReasons(data.data);
                } else {
                    renderTopReasons([]);
                }
            })
            .catch(e => {
                console.error('Error loading reasons:', e);
                renderTopReasons([]);
            });

        // Load impact analysis
        fetch(buildApiUrl('/tracker/api/analytics/delays/impact/'))
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    renderImpactAnalysis(data.impact, data.reason_impact);
                } else {
                    renderImpactAnalysis({}, []);
                }
            })
            .catch(e => {
                console.error('Error loading impact:', e);
                renderImpactAnalysis({}, []);
            });

        // Load recommendations
        fetch(buildApiUrl('/tracker/api/analytics/delays/recommendations/'))
            .then(r => r.json())
            .then(data => {
                if (data.success && data.recommendations && data.recommendations.length > 0) {
                    renderRecommendations(data.recommendations);
                } else {
                    renderRecommendations([]);
                }
                showLoading(false);
            })
            .catch(e => {
                console.error('Error loading recommendations:', e);
                renderRecommendations([]);
                showLoading(false);
            });
    }

    // Update KPI cards
    function updateKPIs(summary, topReasons) {
        document.getElementById('totalDelayed').textContent = summary.total_delayed_orders || 0;
        document.getElementById('delayRate').textContent = (summary.delay_percentage || 0).toFixed(1) + '%';
        document.getElementById('exceeded2Hours').textContent = summary.exceeded_2_hours || 0;
        document.getElementById('avgHours').textContent = (summary.average_hours || 0).toFixed(1);
    }

    // Render category breakdown chart
    function renderCategoryChart(data) {
        const ctx = document.getElementById('categoryBreakdownChart');
        if (!ctx) return;
        
        if (charts.categoryBreakdown) {
            charts.categoryBreakdown.destroy();
        }

        charts.categoryBreakdown = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: data.map(d => d.category_name),
                datasets: [{
                    data: data.map(d => d.count),
                    backgroundColor: [
                        'rgba(79, 70, 229, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(14, 165, 233, 0.8)',
                        'rgba(139, 92, 246, 0.8)',
                        'rgba(236, 72, 153, 0.8)',
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Render trends chart
    function renderTrendsChart(data) {
        const ctx = document.getElementById('trendsChart');
        if (!ctx) return;
        
        if (charts.trends) {
            charts.trends.destroy();
        }

        charts.trends = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [{
                    label: 'Delayed Orders',
                    data: data.map(d => d.delayed_count),
                    borderColor: 'rgba(239, 68, 68, 1)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Exceeded 2 Hours',
                    data: data.map(d => d.exceeded_9h),
                    borderColor: 'rgba(245, 158, 11, 1)',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Render order type chart
    function renderOrderTypeChart(data) {
        const ctx = document.getElementById('orderTypeChart');
        if (!ctx) return;
        
        if (charts.orderType) {
            charts.orderType.destroy();
        }

        charts.orderType = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: data.map(d => d.type_name),
                datasets: [{
                    label: 'Delayed Orders',
                    data: data.map(d => d.count),
                    backgroundColor: 'rgba(79, 70, 229, 0.8)',
                    borderColor: 'rgba(79, 70, 229, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Render user chart
    function renderUserChart(data) {
        const ctx = document.getElementById('userChart');
        if (!ctx) return;
        
        if (charts.user) {
            charts.user.destroy();
        }

        charts.user = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: data.map(d => d.user_name),
                datasets: [{
                    label: 'Total Delays',
                    data: data.map(d => d.delay_count),
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 2
                }, {
                    label: 'Exceeded 2 Hours',
                    data: data.map(d => d.exceeded_2h_count),
                    backgroundColor: 'rgba(245, 158, 11, 0.8)',
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Render top reasons list
    function renderTopReasons(data) {
        const container = document.getElementById('topReasonsList');
        if (!container) return;
        
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><i class="fa fa-inbox"></i></div><p>No delay reasons found for the selected filters</p></div>';
            return;
        }

        container.innerHTML = data.slice(0, 15).map(reason => `
            <div class="reason-item">
                <div>
                    <div class="reason-text">${escapeHtml(reason.reason_text || 'Unknown')}</div>
                    <div class="reason-category">${escapeHtml(reason.category_name || reason.category || 'Uncategorized')}</div>
                </div>
                <div class="reason-stats">
                    <div class="reason-count">${reason.count || 0}</div>
                    <div class="reason-percentage">${(reason.percentage || 0).toFixed(1)}%</div>
                </div>
            </div>
        `).join('');
    }

    // Render impact analysis
    function renderImpactAnalysis(impact, reasonImpact) {
        const container = document.getElementById('impactMetrics');
        if (!container) return;
        
        if (!impact || Object.keys(impact).length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No impact data available</p></div>';
            return;
        }

        container.innerHTML = `
            <div class="col-md-3">
                <div class="impact-metric">
                    <div class="impact-value">${(impact.total_delayed_hours || 0).toFixed(1)}</div>
                    <div class="impact-label">Total Delayed Hours</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="impact-metric">
                    <div class="impact-value">${formatCurrency(impact.estimated_revenue_impact || 0)}</div>
                    <div class="impact-label">Revenue Impact</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="impact-metric">
                    <div class="impact-value">${impact.customers_with_repeat_delays || 0}</div>
                    <div class="impact-label">Repeat Delay Customers</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="impact-metric">
                    <div class="impact-value">${impact.total_unique_customers_affected || 0}</div>
                    <div class="impact-label">Affected Customers</div>
                </div>
            </div>
        `;
    }

    // Render recommendations
    function renderRecommendations(recommendations) {
        const container = document.getElementById('recommendationsList');
        if (!container) return;
        
        if (!recommendations || recommendations.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><i class="fa fa-lightbulb"></i></div><p>No recommendations available. All systems operating normally!</p></div>';
            return;
        }

        container.innerHTML = recommendations.map(rec => `
            <div class="recommendation-card ${rec.priority || 'medium'}">
                <div class="recommendation-header">
                    <div>
                        <div class="recommendation-title">${escapeHtml(rec.title || 'Recommendation')}</div>
                        <div class="recommendation-category">${escapeHtml(rec.category || 'General')}</div>
                    </div>
                    <span class="recommendation-priority ${rec.priority || 'medium'}">${(rec.priority || 'medium').toUpperCase()}</span>
                </div>
                <div class="recommendation-description">${escapeHtml(rec.description || 'No description available')}</div>
            </div>
        `).join('');
    }

    // Format currency
    function formatCurrency(value) {
        const num = parseFloat(value) || 0;
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'TZS',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(num);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Filter form submission - reload page with filters
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        // Build query string
        const params = new URLSearchParams();
        if (filters.period) params.append('period', filters.period);
        if (filters.category) params.append('category', filters.category);
        if (filters.order_type) params.append('order_type', filters.order_type);
        if (filters.user) params.append('user', filters.user);
        
        // Reload page with filters
        window.location.href = '{% url "tracker:delay_analytics_dashboard" %}?' + params.toString();
    });

    // Auto-submit on filter change (optional - can be removed if you prefer manual submit)
    // document.getElementById('periodSelect').addEventListener('change', function() {
    //     document.getElementById('filterForm').requestSubmit();
    // });

    // Initial load
    loadAnalytics();
});
</script>
{% endblock %}
