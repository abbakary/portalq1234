{% extends 'tracker/base.html' %}
{% load static %}
{% load date_filters %}

{% block title %}Inquiries Management Dashboard{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --warning-gradient: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    --dark-bg: linear-gradient(135deg, #2d3436 0%, #000000 100%);
    --card-shadow: 0 10px 30px rgba(0,0,0,0.08);
    --hover-shadow: 0 20px 40px rgba(0,0,0,0.12);
}

/* Header Section */
.dashboard-header {
    background: var(--dark-bg);
    color: white;
    padding: 2.5rem;
    border-radius: 20px;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.dashboard-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
}

.header-content {
    position: relative;
    z-index: 2;
}

.header-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

/* Stats Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--hover-shadow);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.stat-card.total::before { background: var(--primary-gradient); }
.stat-card.new::before { background: var(--info-gradient); }
.stat-card.in-progress::before { background: var(--warning-gradient); }
.stat-card.resolved::before { background: var(--success-gradient); }

.stat-card .icon-wrapper {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
}

.stat-card.total .icon-wrapper { background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); }
.stat-card.new .icon-wrapper { background: linear-gradient(135deg, rgba(79, 195, 247, 0.1) 0%, rgba(2, 119, 189, 0.1) 100%); }
.stat-card.in-progress .icon-wrapper { background: linear-gradient(135deg, rgba(255, 183, 77, 0.1) 0%, rgba(255, 149, 0, 0.1) 100%); }
.stat-card.resolved .icon-wrapper { background: linear-gradient(135deg, rgba(102, 187, 106, 0.1) 0%, rgba(56, 142, 60, 0.1) 100%); }

.stat-value {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-card.total .stat-value { background-image: var(--primary-gradient); }
.stat-card.new .stat-value { background-image: var(--info-gradient); }
.stat-card.in-progress .stat-value { background-image: var(--warning-gradient); }
.stat-card.resolved .stat-value { background-image: var(--success-gradient); }

.stat-label {
    font-size: 0.9rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
}

/* Filters Section */
.filter-section {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: var(--card-shadow);
    margin-bottom: 2rem;
}

.filter-section .form-label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
}

.quick-filters {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.quick-filter-btn {
    padding: 0.5rem 1rem;
    border-radius: 10px;
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    color: #4b5563;
    font-size: 0.875rem;
    transition: all 0.2s;
}

.quick-filter-btn:hover {
    background: #e5e7eb;
    transform: translateY(-1px);
}

.quick-filter-btn.active {
    background: var(--primary-gradient);
    color: white;
    border-color: transparent;
}

/* Inquiry Cards - Enhanced */
.inquiry-cards-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 1.5rem;
}

.inquiry-card {
    background: white;
    border-radius: 20px;
    padding: 1.75rem;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    border: 2px solid transparent;
    position: relative;
    overflow: hidden;
}

.inquiry-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--hover-shadow);
}

.inquiry-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 6px;
    height: 100%;
}

.inquiry-card.status-created::before { background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%); }
.inquiry-card.status-in_progress::before { background: linear-gradient(180deg, #f7971e 0%, #ffd200 100%); }
.inquiry-card.status-completed::before { background: linear-gradient(180deg, #11998e 0%, #38ef7d 100%); }

.inquiry-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.25rem;
}

.customer-info {
    flex: 1;
}

.customer-name {
    font-size: 1.2rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.customer-name i {
    font-size: 1rem;
    opacity: 0.7;
}

.customer-contact {
    font-size: 0.9rem;
    color: #6b7280;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
}

.contact-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* Enhanced Badges */
.badge-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.badge {
    padding: 0.4rem 0.9rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 2px solid transparent;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
}

.badge-status {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    color: #374151;
}

.badge-status.created {
    background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
    color: #1e40af;
    border-color: #93c5fd;
}

.badge-status.in_progress {
    background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
    color: #92400e;
    border-color: #fcd34d;
}

.badge-status.completed {
    background: linear-gradient(135deg, #d1fae5 0%, #6ee7b7 100%);
    color: #065f46;
    border-color: #6ee7b7;
}

.badge-type {
    background: linear-gradient(135deg, #f3e8ff 0%, #d8b4fe 100%);
    color: #6b21a8;
    border-color: #d8b4fe;
}

.badge-priority {
    font-size: 0.7rem;
}

.badge-priority.high {
    background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%);
    color: #991b1b;
    border-color: #fca5a5;
}

.badge-priority.urgent {
    background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    color: white;
    border-color: transparent;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

/* Inquiry Content */
.inquiry-content {
    margin: 1.25rem 0;
    padding: 1.25rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 15px;
    border-left: 4px solid;
}

.inquiry-card.status-created .inquiry-content { border-left-color: #4facfe; }
.inquiry-card.status-in_progress .inquiry-content { border-left-color: #f7971e; }
.inquiry-card.status-completed .inquiry-content { border-left-color: #11998e; }

.inquiry-questions {
    color: #374151;
    line-height: 1.7;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 100px;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.inquiry-questions::-webkit-scrollbar {
    width: 4px;
}

.inquiry-questions::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
}

/* Footer & Actions */
.inquiry-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1.5rem;
    padding-top: 1.25rem;
    border-top: 2px solid #f3f4f6;
    flex-wrap: wrap;
    gap: 1rem;
}

.timeline-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.timeline-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
}

.timeline-item i {
    width: 16px;
    text-align: center;
}

.overdue-alert {
    animation: shake 0.5s ease-in-out infinite;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    75% { transform: translateX(2px); }
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.action-btn {
    padding: 0.6rem 1.2rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.action-btn.view-btn {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
}

.action-btn.view-btn:hover {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
}

.action-btn.respond-btn {
    background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
    color: white;
}

.action-btn.respond-btn:hover {
    background: linear-gradient(135deg, #059669 0%, #10b981 100%);
}

.action-btn.resolve-btn {
    background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
    color: white;
}

.action-btn.resolve-btn:hover {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
}

/* Detail View Modal */
.detail-modal .modal-content {
    border-radius: 25px;
    border: none;
    overflow: hidden;
}

.detail-modal .modal-header {
    background: var(--dark-bg);
    color: white;
    padding: 2rem;
    border-bottom: none;
}

.detail-modal .modal-body {
    padding: 2rem;
    max-height: 70vh;
    overflow-y: auto;
}

.detail-section {
    background: #f9fafb;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.detail-section-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.detail-label {
    font-size: 0.85rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.detail-value {
    font-size: 1rem;
    color: #374151;
    font-weight: 500;
}

.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(180deg, #6366f1 0%, #8b5cf6 100%);
}

.timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -34px;
    top: 0;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #6366f1;
    border: 3px solid white;
    box-shadow: 0 0 0 3px #6366f1;
}

.timeline-date {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
}

.timeline-content {
    background: white;
    padding: 1rem;
    border-radius: 10px;
    border-left: 3px solid #6366f1;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 25px;
    box-shadow: var(--card-shadow);
}

.empty-state-icon {
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
}

.empty-state-icon i {
    font-size: 3rem;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* Responsive Design */
@media (max-width: 768px) {
    .dashboard-header {
        text-align: center;
        padding: 2rem 1.5rem;
    }
    
    .header-actions {
        justify-content: center;
        margin-top: 1rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .inquiry-cards-container {
        grid-template-columns: 1fr;
    }
    
    .inquiry-footer {
        flex-direction: column;
        align-items: stretch;
    }
    
    .action-buttons {
        width: 100%;
        justify-content: center;
    }
    
    .action-btn {
        flex: 1;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-lg-4">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-4">
                <div>
                    <h1 class="display-6 fw-bold mb-2">
                        <i class="fa fa-comments me-3"></i>Inquiries Dashboard
                    </h1>
                    <p class="opacity-90 mb-0">
                        <i class="fa fa-chart-line me-2"></i>Manage customer inquiries with efficiency and insight
                    </p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-light btn-lg d-flex align-items-center gap-2" 
                            data-bs-toggle="modal" 
                            data-bs-target="#createInquiryModal">
                        <i class="fa fa-plus-circle"></i>
                        <span>New Inquiry</span>
                    </button>
                    <a href="#" class="btn btn-outline-light btn-lg d-flex align-items-center gap-2">
                        <i class="fa fa-download"></i>
                        <span>Export</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card total">
            <div class="icon-wrapper">
                <i class="fa fa-inbox fa-2x" style="color: #667eea;"></i>
            </div>
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">Total Inquiries</div>
            <div class="mt-2 small text-muted">All customer inquiries</div>
        </div>
        
        <div class="stat-card new">
            <div class="icon-wrapper">
                <i class="fa fa-clock fa-2x" style="color: #4facfe;"></i>
            </div>
            <div class="stat-value">{{ stats.new }}</div>
            <div class="stat-label">New</div>
            <div class="mt-2 small text-muted">Awaiting response</div>
        </div>
        
        <div class="stat-card in-progress">
            <div class="icon-wrapper">
                <i class="fa fa-spinner fa-spin fa-2x" style="color: #f7971e;"></i>
            </div>
            <div class="stat-value">{{ stats.in_progress }}</div>
            <div class="stat-label">In Progress</div>
            <div class="mt-2 small text-muted">Being handled</div>
        </div>
        
        <div class="stat-card resolved">
            <div class="icon-wrapper">
                <i class="fa fa-check-circle fa-2x" style="color: #11998e;"></i>
            </div>
            <div class="stat-value">{{ stats.resolved }}</div>
            <div class="stat-label">Resolved</div>
            <div class="mt-2 small text-muted">Successfully closed</div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filter-section">
        <h5 class="mb-3"><i class="fa fa-filter me-2"></i>Filter Inquiries</h5>
        <form method="get" class="row g-4">
            <div class="col-lg-3 col-md-6">
                <label class="form-label">Inquiry Type</label>
                <select name="type" class="form-select form-select-lg">
                    <option value="">All Types</option>
                    <option value="Pricing" {% if request.GET.type == 'Pricing' %}selected{% endif %}>Pricing</option>
                    <option value="Services" {% if request.GET.type == 'Services' %}selected{% endif %}>Services</option>
                    <option value="Appointment Booking" {% if request.GET.type == 'Appointment Booking' %}selected{% endif %}>Appointment</option>
                    <option value="General" {% if request.GET.type == 'General' %}selected{% endif %}>General</option>
                    <option value="Complaint" {% if request.GET.type == 'Complaint' %}selected{% endif %}>Complaint</option>
                    <option value="Feedback" {% if request.GET.type == 'Feedback' %}selected{% endif %}>Feedback</option>
                </select>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <label class="form-label">Status</label>
                <select name="status" class="form-select form-select-lg">
                    <option value="">All Statuses</option>
                    <option value="created" {% if request.GET.status == 'created' %}selected{% endif %}>New</option>
                    <option value="in_progress" {% if request.GET.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Resolved</option>
                </select>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <label class="form-label">Priority</label>
                <select name="priority" class="form-select form-select-lg">
                    <option value="">All Priorities</option>
                    <option value="low" {% if request.GET.priority == 'low' %}selected{% endif %}>Low</option>
                    <option value="medium" {% if request.GET.priority == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="high" {% if request.GET.priority == 'high' %}selected{% endif %}>High</option>
                    <option value="urgent" {% if request.GET.priority == 'urgent' %}selected{% endif %}>Urgent</option>
                </select>
            </div>
            
            <div class="col-lg-3 col-md-6 d-flex align-items-end">
                <button type="submit" class="btn btn-primary btn-lg w-100 d-flex align-items-center justify-content-center gap-2">
                    <i class="fa fa-search"></i>
                    <span>Apply Filters</span>
                </button>
            </div>
        </form>
        
        <!-- Quick Filters -->
        <div class="quick-filters">
            <button class="quick-filter-btn {% if not request.GET.status %}active{% endif %}" onclick="window.location.href='?'">
                All Inquiries
            </button>
            <button class="quick-filter-btn {% if request.GET.status == 'created' %}active{% endif %}" 
                    onclick="window.location.href='?status=created'">
                New Only
            </button>
            <button class="quick-filter-btn {% if request.GET.follow_up == 'overdue' %}active{% endif %}" 
                    onclick="window.location.href='?follow_up=overdue'">
                Overdue
            </button>
            <button class="quick-filter-btn" onclick="window.location.href='?priority=urgent'">
                Urgent
            </button>
        </div>
    </div>

    <!-- Inquiries List -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">
                <i class="fa fa-list me-2"></i>Customer Inquiries
                <span class="badge bg-primary ms-2">{{ inquiries|length }}</span>
            </h4>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="toggleViewMode()">
                    <i class="fa fa-th-large"></i>
                </button>
                <button class="btn btn-outline-primary" onclick="location.reload()">
                    <i class="fa fa-sync-alt"></i>
                </button>
            </div>
        </div>
        
        {% if inquiries %}
        <div class="inquiry-cards-container" id="inquiryCards">
            {% for inquiry in inquiries %}
            <div class="inquiry-card status-{{ inquiry.status }}" data-id="{{ inquiry.id }}">
                <div class="inquiry-header">
                    <div class="customer-info">
                        <div class="customer-name">
                            <i class="fa fa-user-circle"></i>
                            {{ inquiry.customer.full_name|default:"Anonymous Customer" }}
                        </div>
                        <div class="customer-contact">
                            {% if inquiry.customer.phone %}
                            <span class="contact-item">
                                <i class="fa fa-phone text-primary"></i>
                                {{ inquiry.customer.phone }}
                            </span>
                            {% endif %}
                            {% if inquiry.customer.email %}
                            <span class="contact-item">
                                <i class="fa fa-envelope text-danger"></i>
                                {{ inquiry.customer.email }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="badge-container">
                        <span class="badge badge-status {{ inquiry.status }}">
                            <i class="fa fa-{% if inquiry.status == 'created' %}clock{% elif inquiry.status == 'in_progress' %}spinner fa-spin{% else %}check-circle{% endif %}"></i>
                            {{ inquiry.get_status_display }}
                        </span>
                        <span class="badge badge-type">
                            <i class="fa fa-tag"></i>
                            {{ inquiry.inquiry_type|default:"General" }}
                        </span>
                        {% if inquiry.priority %}
                        <span class="badge badge-priority {{ inquiry.priority }}">
                            <i class="fa fa-flag"></i>
                            {{ inquiry.get_priority_display|default:inquiry.priority|title }}
                        </span>
                        {% endif %}
                    </div>
                </div>

                <div class="inquiry-content">
                    <h6 class="mb-2 text-muted">
                        <i class="fa fa-question-circle me-2"></i>Inquiry Details
                    </h6>
                    <div class="inquiry-questions">
                        {{ inquiry.questions|default:"No details provided"|truncatechars:200 }}
                    </div>
                </div>

                <div class="inquiry-footer">
                    <div class="timeline-info">
                        <div class="timeline-item">
                            <i class="fa fa-calendar-plus text-primary"></i>
                            <span>Created: {{ inquiry.created_at|date_medium }}</span>
                        </div>
                        {% if inquiry.follow_up_date %}
                        <div class="timeline-item {% if inquiry.follow_up_date <= today and inquiry.status != 'completed' %}overdue-alert{% endif %}">
                            <i class="fa fa-bell {% if inquiry.follow_up_date <= today and inquiry.status != 'completed' %}text-danger{% else %}text-warning{% endif %}"></i>
                            <span>Follow-up: {{ inquiry.follow_up_date|date_medium }}</span>
                            {% if inquiry.follow_up_date <= today and inquiry.status != 'completed' %}
                            <span class="badge bg-danger ms-2">Overdue!</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn view-btn" onclick="viewInquiryDetails({{ inquiry.id }})">
                            <i class="fa fa-eye"></i>
                            <span>View Details</span>
                        </button>
                        {% if inquiry.status != 'completed' %}
                        <button class="action-btn respond-btn" onclick="respondToInquiry({{ inquiry.id }})">
                            <i class="fa fa-reply"></i>
                            <span>Respond</span>
                        </button>
                        <form method="post" action="{% url 'tracker:update_inquiry_status' inquiry.id %}" 
                              class="d-inline" onsubmit="return confirmResolve()">
                            {% csrf_token %}
                            <input type="hidden" name="status" value="completed">
                            <button type="submit" class="action-btn resolve-btn">
                                <i class="fa fa-check"></i>
                                <span>Resolve</span>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if inquiries.has_other_pages %}
        <nav class="mt-4" aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if inquiries.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ inquiries.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        <i class="fa fa-chevron-left"></i> Previous
                    </a>
                </li>
                {% endif %}
                
                {% for i in inquiries.paginator.page_range %}
                    {% if i >= inquiries.number|add:"-2" and i <= inquiries.number|add:"2" %}
                    <li class="page-item {% if i == inquiries.number %}active{% endif %}">
                        <a class="page-link" href="?page={{ i }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            {{ i }}
                        </a>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if inquiries.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ inquiries.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        Next <i class="fa fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fa fa-inbox"></i>
            </div>
            <h3 class="mb-3">No Inquiries Found</h3>
            <p class="text-muted mb-4">There are no customer inquiries matching your current filters.</p>
            <button class="btn btn-primary btn-lg px-4" data-bs-toggle="modal" data-bs-target="#createInquiryModal">
                <i class="fa fa-plus me-2"></i>Create Your First Inquiry
            </button>
            <div class="mt-3">
                <a href="?" class="text-primary">Clear filters</a> to see all inquiries
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Detail View Modal -->
<div class="modal fade detail-modal" id="inquiryDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title mb-1">
                        <i class="fa fa-file-alt me-2"></i>Inquiry Details
                    </h5>
                    <p class="mb-0 opacity-75 small">ID: <span id="detailInquiryId">--</span></p>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detailModalContent">
                <!-- Content will be loaded dynamically -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading inquiry details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="detailRespondBtn">
                    <i class="fa fa-reply me-2"></i>Respond
                </button>
                <button type="button" class="btn btn-success" id="detailResolveBtn">
                    <i class="fa fa-check me-2"></i>Mark as Resolved
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Inquiry Modal (Enhanced) -->
<div class="modal fade" id="createInquiryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title">
                    <i class="fa fa-plus-circle me-2"></i>Create New Inquiry
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createInquiryForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Rest of your existing modal form -->
                    <!-- ... (Your existing form content remains the same) ... -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-check me-2"></i>Create Inquiry
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Respond Modal (Enhanced) -->
<div class="modal fade" id="respondModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                <h5 class="modal-title">
                    <i class="fa fa-reply me-2"></i>Respond to Inquiry
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="respondForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Rest of your existing respond form -->
                    <!-- ... (Your existing form content remains the same) ... -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Response</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Current inquiry ID for actions
let currentInquiryId = null;

// View Inquiry Details Function
function viewInquiryDetails(inquiryId) {
    currentInquiryId = inquiryId;
    
    // Show loading state
    document.getElementById('detailInquiryId').textContent = inquiryId;
    document.getElementById('detailModalContent').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading inquiry details...</p>
        </div>
    `;
    
    // Fetch inquiry details
    fetch(`/tracker/api/inquiries/${inquiryId}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            renderInquiryDetails(data.inquiry);
        } else {
            showError('Failed to load inquiry details');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Error loading inquiry details');
    });
    
    // Show the modal
    const detailModal = new bootstrap.Modal(document.getElementById('inquiryDetailModal'));
    detailModal.show();
}

// Render Inquiry Details in Modal
function renderInquiryDetails(inquiry) {
    const content = document.getElementById('detailModalContent');
    
    // Format dates
    const createdDate = new Date(inquiry.created_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const followUpDate = inquiry.follow_up_date ? new Date(inquiry.follow_up_date).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    }) : 'Not set';
    
    // Create status badge
    let statusBadge = '';
    switch(inquiry.status) {
        case 'created':
            statusBadge = '<span class="badge bg-info">New</span>';
            break;
        case 'in_progress':
            statusBadge = '<span class="badge bg-warning">In Progress</span>';
            break;
        case 'completed':
            statusBadge = '<span class="badge bg-success">Resolved</span>';
            break;
        default:
            statusBadge = '<span class="badge bg-secondary">Unknown</span>';
    }
    
    // Create priority badge
    let priorityBadge = '';
    switch(inquiry.priority) {
        case 'urgent':
            priorityBadge = '<span class="badge bg-danger">Urgent</span>';
            break;
        case 'high':
            priorityBadge = '<span class="badge bg-warning">High</span>';
            break;
        case 'medium':
            priorityBadge = '<span class="badge bg-primary">Medium</span>';
            break;
        case 'low':
            priorityBadge = '<span class="badge bg-secondary">Low</span>';
            break;
    }
    
    // Build HTML
    content.innerHTML = `
        <div class="detail-grid mb-4">
            <div class="detail-item">
                <div class="detail-label">Customer</div>
                <div class="detail-value">
                    <strong>${inquiry.customer.full_name || 'Anonymous'}</strong>
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Contact</div>
                <div class="detail-value">
                    ${inquiry.customer.phone ? `<div><i class="fa fa-phone me-2"></i>${inquiry.customer.phone}</div>` : ''}
                    ${inquiry.customer.email ? `<div class="mt-1"><i class="fa fa-envelope me-2"></i>${inquiry.customer.email}</div>` : ''}
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Status</div>
                <div class="detail-value">${statusBadge}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Priority</div>
                <div class="detail-value">${priorityBadge}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Inquiry Type</div>
                <div class="detail-value">${inquiry.inquiry_type || 'General'}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Created</div>
                <div class="detail-value">${createdDate}</div>
            </div>
        </div>
        
        <div class="detail-section">
            <div class="detail-section-title">
                <i class="fa fa-question-circle"></i>
                Inquiry Details
            </div>
            <div class="p-3 bg-white rounded border">
                ${inquiry.questions || 'No details provided'}
            </div>
        </div>
        
        <div class="detail-section">
            <div class="detail-section-title">
                <i class="fa fa-history"></i>
                Timeline
            </div>
            <div class="timeline">
                <div class="timeline-item">
                    <div class="timeline-date">${createdDate}</div>
                    <div class="timeline-content">
                        <strong>Inquiry Created</strong>
                        <p class="mb-0 small">Inquiry was submitted by ${inquiry.customer.full_name || 'customer'}</p>
                    </div>
                </div>
                ${inquiry.follow_up_date ? `
                <div class="timeline-item">
                    <div class="timeline-date">${followUpDate}</div>
                    <div class="timeline-content">
                        <strong>Follow-up Scheduled</strong>
                        <p class="mb-0 small">Follow-up required by this date</p>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
        
        ${inquiry.notes ? `
        <div class="detail-section">
            <div class="detail-section-title">
                <i class="fa fa-sticky-note"></i>
                Internal Notes
            </div>
            <div class="p-3 bg-light rounded">
                ${inquiry.notes}
            </div>
        </div>
        ` : ''}
    `;
    
    // Update action buttons
    const respondBtn = document.getElementById('detailRespondBtn');
    const resolveBtn = document.getElementById('detailResolveBtn');
    
    respondBtn.onclick = () => {
        const detailModal = bootstrap.Modal.getInstance(document.getElementById('inquiryDetailModal'));
        detailModal.hide();
        respondToInquiry(currentInquiryId);
    };
    
    resolveBtn.onclick = () => {
        if (confirm('Are you sure you want to mark this inquiry as resolved?')) {
            fetch(`/tracker/inquiries/${currentInquiryId}/update-status/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'status=completed'
            })
            .then(response => {
                if (response.ok) {
                    const detailModal = bootstrap.Modal.getInstance(document.getElementById('inquiryDetailModal'));
                    detailModal.hide();
                    location.reload();
                } else {
                    alert('Failed to update status');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating status');
            });
        }
    };
    
    // Hide resolve button if already resolved
    if (inquiry.status === 'completed') {
        resolveBtn.disabled = true;
        resolveBtn.innerHTML = '<i class="fa fa-check me-2"></i>Already Resolved';
        resolveBtn.classList.remove('btn-success');
        resolveBtn.classList.add('btn-secondary');
    }
}

// Respond to Inquiry
function respondToInquiry(inquiryId) {
    currentInquiryId = inquiryId;
    
    // Set up the form
    const respondForm = document.getElementById('respondForm');
    if (respondForm) {
        respondForm.onsubmit = function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            formData.append('inquiry_id', inquiryId);
            
            fetch('/tracker/inquiries/respond/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('respondModal'));
                    modal.hide();
                    location.reload();
                } else {
                    alert('Failed to send response');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending response');
            });
        };
        
        // Show the modal
        const respondModal = new bootstrap.Modal(document.getElementById('respondModal'));
        respondModal.show();
    }
}

// Helper Functions
function showError(message) {
    document.getElementById('detailModalContent').innerHTML = `
        <div class="alert alert-danger" role="alert">
            <i class="fa fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

function confirmResolve() {
    return confirm('Are you sure you want to mark this inquiry as resolved?');
}

function toggleViewMode() {
    const container = document.getElementById('inquiryCards');
    container.classList.toggle('list-view');
}

// Initialize quick filter buttons
document.addEventListener('DOMContentLoaded', function() {
    // Add animation to cards on load
    const cards = document.querySelectorAll('.inquiry-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate__animated', 'animate__fadeInUp');
    });
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}